# Ralph Progress Log
## Codebase Patterns
- `cmd/dropserve` hosts the main CLI/server entrypoint.
- Control API payload types live in `internal/control/api.go` for shared CLI/server use.
- Control service binds to `DROPSERVE_CONTROL_ADDR` (default loopback).
- Public API handlers live in `internal/publicapi` and share portal state via `control.Store`.
- Path sanitization helpers live in `internal/pathsafe` for relpath validation.
- Upload state is tracked in `control.Store` and mirrored as `.dropserve_tmp/<portal_id>/uploads/{upload_id}.json` metadata.
- Track active upload counts with `Store.StartUpload`, `MarkUploadFailed`, and `MarkUploadCommitted`.
- Sweeper settings and temp dir names come from `internal/config` and are shared across services.
- Portal lifecycle state is tracked in `control.Store` via `PortalState` and refreshed by `Store.SweepPortals`.
- Public HTML UI is embedded in `internal/publicapi/server.go` for `/` and `/p/{portal_id}` pages.
- Folder drop handling uses `webkitGetAsEntry` traversal in the portal UI script.

Started: Thu Jan 29 06:43:34 PM MST 2026
---

## Thu Jan 29 10:24:02 PM MST 2026 - US-001
Session: N/A
- Implemented the control API server and the `dropserve open` CLI flow with LAN IP detection.
- Files changed: `go.mod`, `cmd/dropserve/main.go`, `internal/control/api.go`, `internal/control/server.go`, `internal/control/store.go`, `internal/cli/open.go`, `internal/cli/ip.go`, `docs/09_CLI_Spec.md`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - Control API payloads are centralized in `internal/control/api.go` for reuse.
  - `dropserve serve` starts the control API on `DROPSERVE_CONTROL_ADDR`.
  - CLI prints URLs using `DROPSERVE_PUBLIC_ADDR` port when provided.
---

## Thu Jan 29 10:34:11 PM MST 2026 - US-002
Session: N/A
- Implemented the public claim endpoint with client token issuance and policy defaults.
- Files changed: `cmd/dropserve/main.go`, `internal/control/store.go`, `internal/publicapi/server.go`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - `control.Store` tracks client tokens and exposes `RequireClientToken` for public API auth checks.
  - `dropserve serve` now starts both control and public services from `cmd/dropserve/main.go`.
---

## Thu Jan 29 10:40:14 PM MST 2026 - US-005
Session: N/A
- Implemented relpath sanitization and containment checks for uploads.
- Files changed: `internal/pathsafe/pathsafe.go`, `internal/pathsafe/pathsafe_test.go`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - Use `pathsafe.SanitizeRelpath` and `pathsafe.JoinAndVerify` for relpath safety.
  - Path validation tests live in `internal/pathsafe`.
  - `go test ./...` exercises the new path safety checks.
---

## Thu Jan 29 10:53:15 PM MST 2026 - US-006
Session: N/A
- Implemented upload initialization, streaming, hashing, and atomic commit handling.
- Files changed: `internal/control/store.go`, `internal/control/server.go`, `internal/publicapi/server.go`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - Upload metadata is written to `.dropserve_tmp/<portal_id>/uploads` during init and used for cleanup workflows.
  - `PUT /api/uploads/{upload_id}` validates `Content-Length` and optional client SHA-256 before rename.
---

## Thu Jan 29 11:15:00 PM MST 2026 - US-008
Session: N/A
- Implemented active upload tracking and failure cleanup during PUT streams.
- Files changed: `internal/control/store.go`, `internal/publicapi/server.go`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - `Store.StartUpload` increments portal active counts at stream start.
  - `MarkUploadFailed` and `MarkUploadCommitted` decrement active counts when uploads end.
  - Use `failUpload` on PUT errors to delete `.part` and `.json` artifacts.
---

## Thu Jan 29 11:11:28 PM MST 2026 - US-009
Session: N/A
- Implemented startup and periodic sweep logic for stale temp artifacts and portal directories.
- Files changed: `cmd/dropserve/main.go`, `docs/11_Config_Reference.md`, `internal/config/config.go`, `internal/control/store.go`, `internal/publicapi/server.go`, `internal/sweeper/sweeper.go`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - The sweeper in `internal/sweeper` uses `control.Store` snapshots to skip active uploads.
  - Startup sweep runs before servers accept requests in `cmd/dropserve/main.go`.
  - Sweep roots default to the current working directory via `DROPSERVE_SWEEP_ROOTS`.
---

## Thu Jan 29 11:35:59 PM MST 2026 - US-010
Session: N/A
- Implemented portal expiry/closing state transitions plus a public close endpoint with cleanup.
- Files changed: `internal/control/store.go`, `internal/publicapi/server.go`, `internal/sweeper/sweeper.go`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - Portal state transitions are refreshed via `Store.SweepPortals` and `refreshPortalLocked`.
  - `/api/portals/{portal_id}/close` returns 409 when active uploads remain.
  - Closed/expired portal temp dirs are removed by the close handler and sweeper.
---

## Thu Jan 29 11:44:57 PM MST 2026 - US-003
Session: N/A
- Implemented landing and portal pages with sequential uploads, queue state, and progress stats.
- Files changed: `internal/publicapi/server.go`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - The portal UI claims a portal before enabling uploads.
  - Sequential uploads use init + PUT with `X-Client-Token` from the browser.
---

## Thu Jan 29 11:50:15 PM MST 2026 - US-004
Session: N/A
- Implemented folder selection and drag-and-drop traversal for nested uploads.
- Files changed: `internal/publicapi/server.go`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - Folder selection uses `webkitdirectory` input and dropped folders are traversed via `webkitGetAsEntry`.
  - Queue items store relpaths from `webkitRelativePath` or entry fullPath.
---
