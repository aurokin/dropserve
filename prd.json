{
  "project": "DropServe LAN Upload Portal",
  "description": "Self-hosted LAN-only upload portal with safe streaming, cleanup, and sequential web uploads.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Open a portal from the CLI",
      "description": "As a server operator, I want to open a portal from the destination directory so that uploads land in the correct location without exposing absolute paths to browsers.",
      "acceptanceCriteria": [
        "dropserve open uses canonical current directory as dest_abs",
        "CLI calls POST /api/control/portals and prints http://{lan-ip}/p/{portal_id}",
        "CLI supports --minutes, --reusable, and --policy flags",
        "Control API binds to loopback only by default",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Claim a portal from the browser",
      "description": "As a browser user, I want to claim a portal so that I can upload files securely with a client token.",
      "acceptanceCriteria": [
        "POST /api/portals/{portal_id}/claim returns client_token and policy defaults",
        "One-time portals reject subsequent claims with HTTP 409",
        "State-changing endpoints require X-Client-Token after claim",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Prevent path traversal",
      "description": "As a system owner, I want all user-supplied paths sanitized so that uploads never escape the destination directory.",
      "acceptanceCriteria": [
        "Paths containing .., absolute prefixes, or Windows drive letters are rejected",
        "Backslashes are normalized to forward slashes before validation",
        "Final absolute path is verified to be contained within dest_abs",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Stream uploads safely to disk",
      "description": "As a system owner, I want uploads streamed to disk with verification so that large files are handled safely and consistently.",
      "acceptanceCriteria": [
        "PUT /api/uploads/{upload_id} streams bytes without buffering entire files",
        "Server verifies Content-Length and optional client SHA-256",
        "Uploads only appear in the final destination after atomic rename",
        "Server returns server_sha256 and bytes_received on commit",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Cleanup incomplete uploads",
      "description": "As a system owner, I want immediate cleanup on failed or canceled uploads so that no partial files remain.",
      "acceptanceCriteria": [
        ".part and .json files are deleted on any upload failure or cancel",
        "Final destination never contains partial files",
        "Portal active_uploads is decremented on all error paths",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Sweep orphaned temp artifacts",
      "description": "As a system owner, I want a startup and periodic sweeper so that crashed uploads are removed automatically.",
      "acceptanceCriteria": [
        "Startup sweep removes stale portal temp directories and old .part files",
        "Periodic sweep runs on a configurable interval",
        "Sweeper never deletes committed files",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Expire portals safely",
      "description": "As a server operator, I want portals to expire without interrupting active uploads so users can finish transfers safely.",
      "acceptanceCriteria": [
        "Unused portals expire after open_until and are cleaned",
        "Used portals remain valid until active_uploads drains to zero",
        "One-time portals close after the queue completes",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Upload files with sequential progress",
      "description": "As a browser user, I want to upload a queue of files sequentially so that large transfers are reliable and I can see overall progress.",
      "acceptanceCriteria": [
        "UI queues multiple files/folders and uploads one at a time",
        "UI displays total bytes, bytes uploaded, and rolling transfer speed",
        "UI calls init then PUT for each file using the public API",
        "Verify in browser using dev-browser skill",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Upload folders with preserved structure",
      "description": "As a browser user, I want to upload folders so that nested structure is preserved in the destination directory.",
      "acceptanceCriteria": [
        "UI accepts drag-and-drop files and folder selection via webkitdirectory",
        "The client uses webkitRelativePath when available",
        "Empty directories are not uploaded",
        "Verify in browser using dev-browser skill",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Resolve filename conflicts",
      "description": "As a browser user, I want clear overwrite behavior and automatic renaming for conflicts so I can choose how collisions are handled.",
      "acceptanceCriteria": [
        "Preflight reports existing conflicts before uploads begin",
        "UI shows warning and toggle for autorename policy",
        "Autorename uses name_YYYY-MM-DD_HHMMSS.ext and adds _2, _3 when needed",
        "Verify in browser using dev-browser skill",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Deploy behind Caddy on LAN",
      "description": "As a server operator, I want a simple Caddy configuration so that the app is LAN-only and safe.",
      "acceptanceCriteria": [
        "Caddyfile enforces LAN-only access using private IP ranges",
        "Public service is proxied to 127.0.0.1:8080",
        "Control service is not proxied",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    }
  ]
}
